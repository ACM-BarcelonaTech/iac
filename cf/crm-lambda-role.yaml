AWSTemplateFormatVersion: "2010-09-09"
Description: Set up role for the CRM Lambda [managed by github.com/biomage-ltd/iac]

Parameters:    
  Environment:
    Type: String
    Default: development
    AllowedValues:
      - development
      - staging
      - production
    Description: The environment for which the role needs to be created.

Resources:
  DailyUpdateLambdaRole:
    Type: "AWS::IAM::Role"
    Properties:
      RoleName: "crm-lambda-role"
      AssumeRolePolicyDocument: |-
        {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "lambda.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        }
      Path: /
      Policies:
        - PolicyName: "can-execute-crm-lambda"
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action: "lambda:Invoke"
                Resource: !Sub "arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:crm-*"
        - PolicyName: "can-access-dynamodb-tables"
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action: 
                  - "dynamodb:GetItem"
                  - "dynamodb:BatchGetItem"
                  - "dynamodb:Scan"
                  - "dynamodb:Query"
                  - "dynamodb:ConditionCheckItem"
                Resource: 
                  - !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/experiments-${Environment}*"
                  - !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/projects-${Environment}*"
        - PolicyName: "can-check-existence-of-s3-objects"
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action: 
                  - "s3:GetObject"
                  - "s3:ListObject"
                Resource: 
                  - !Sub "arn:aws:s3:::biomage-originals-${Environment}/*"
                  - !Sub "arn:aws:s3:::biomage-source-${Environment}/*"